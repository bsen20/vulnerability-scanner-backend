const { PythonShell } = require("python-shell");
const validUrl = require("valid-url");
const scanUrl = async (req, res) => {
  const url = req.query.url;
  console.log(url);
  if (validUrl.isUri(url)) {
    try {
      let options = {
        args: [url],
      };
      let sqli,
        xss,
        sub_domain = null;
      let timing = 22000;
      const scanner_function = async () => {
        await PythonShell.run("xss_scan.py", options, function (err, results) {
          if (err) res.status(500).json({ message: "Something went wrong" });
          xss = results;
        });
        await PythonShell.run("sqli_scan.py", options, function (err, results) {
          if (err) res.status(500).json({ message: "Something went wrong" });
          sqli = results;
        });
        await PythonShell.run(
          "sub_domain.py",
          options,
          function (err, results) {
            if (err) res.status(500).json({ message: "Something went wrong" });
            sub_domain = results;
          }
        );
      };
      const results_function = () => {
        res.status(201).json({ xss: xss, sqli: sqli, sub_domain: sub_domain });
        console.log("XSS Attack Summary :", xss);
        console.log("SQLI Attack Summary :", sqli);
        console.log("Sub Domains are : ", sub_domain);
      };
      scanner_function();
      setTimeout(() => {
        results_function();
      }, timing);
    } catch (error) {
      console.log(error);
      res.status(500).json({ message: "Something went wrong" });
    }
  } else {
    res.status(500).json({ message: "Enter a valid URL" });
  }
};
module.exports = { scanUrl };
